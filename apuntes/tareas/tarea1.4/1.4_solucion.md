# **Solución: Tarea 1.4: Creación de un Shell Restringido**  

### **Comandos Utilizados**  

Creacción del usuario `carmela`.

```bash
┌──(kali㉿kali)-[~]
└─$ sudo useradd -m -d /home/carmela -s /bin/bash -p $(mkpasswd 'abc123.') carmela
[sudo] password for kali:

┌──(kali㉿kali)-[~]
└─$ tail -n 1 /etc/passwd
carmela:x:1002:1002::/home/carmela:/bin/bash
```

1. En la terminal de administrador, edita `/etc/passwd` para que el shell por defecto de `carmela` sea `/bin/rbash` en lugar de `/bin/bash`.
```bash
grep carmela /etc/passwd | sed 's/\/bin\/bash/\/bin\/rbash/' /etc/passwd | tail -n 1 /etc/passwd
```

```bash
┌──(root㉿kali)-[~]
└─# grep carmela /etc/passwd | sed 's/\/bin\/bash/\/bin\/rbash/' /etc/passwd | tail -n 1 /etc/passwd
carmela:x:1002:1002::/home/carmela:/bin/rbash
```

_*Nota*_: Diferencia entre shell `bash` y `rbash`.
`rbash` (restricted bash) es una versión limitada de `bash` que restringe ciertas acciones para el usuario. Algunas de las limitaciones más comunes son:

1. No permite cambiar de directorio con el comando `cd`.
2. No permite ejecutar comandos fuera de un conjunto específico, como los que están en el `PATH` o en una lista permitida.
3. Desactiva el uso de ciertos comandos (como `exec`, `source` y otros).
4. Puede restringir el acceso a variables de entorno y a otros archivos del sistema.

En resumen, `rbash` limita la capacidad del usuario para interactuar con el sistema de manera más libre que `bash`. Esto se usa generalmente para proporcionar un entorno más controlado.

2. En la terminal de `carmela`, inicia sesión como `carmela` ejecutando:
```bash
sudo -u carmela -i
```

```bash
┌──(kali㉿kali)-[~]
└─$ sudo -u carmela -i
```

_*Nota*_: El comando `sudo -u carmela -i` realiza lo siguiente:
- **`sudo`** → Ejecuta un comando como otro usuario con privilegios.  
- **`-u carmela`** → Especifica que el comando se ejecutará como el usuario `carmela`.  
- **`-i`** → Inicia una sesión interactiva de login shell, lo que significa que:  
  - Se carga el entorno del usuario (`~/.bashrc`, `~/.profile`, etc.).  
  - Cambia al directorio personal del usuario (`/home/carmela`).  
  - Se establece el shell por defecto del usuario.  
Es equivalente a `su - carmela`

3. En la terminal de `carmela`, verifica que:
- Eres `carmela` con `whoami`.
- Estás en `/home/carmela` con `pwd`.
- Usas un bash restringido con `ps`.
- El autocompletado con la tecla tabulador ya no funciona y no puedes cambiar de directorio con `cd`.
- Comandos como `ps` y `ls` siguen funcionando.
- `echo $PATH` muestra rutas como `/usr/bin`, `/bin`, etc. Esto debe corregirse en el siguiente paso.
```bash
whoami
pwd
ps
cd #Error
ps/ls
echo $PATH
```

```bash
┌──(carmela㉿kali)-[~]
└─$ whoami
carmela

┌──(carmela㉿kali)-[~]
└─$ pwd
/home/carmela

┌──(carmela㉿kali)-[~]
└─$ ps
    PID TTY          TIME CMD
  11408 pts/4    00:00:00 rbash
  16127 pts/4    00:00:00 ps

┌──(carmela㉿kali)-[~]
└─$ cd
-rbash: cd: restricted

┌──(carmela㉿kali)-[~]
└─$ ls

┌──(carmela㉿kali)-[~]
└─$ echo $PATH
/home/carmela/.local/bin:/usr/local/sbin:/usr/sbin:/sbin:/usr/local/bin:/usr/bin:/bin:/usr/local/games:/usr/games:/home/carmela/.dotnet/tools
```

4. En la terminal de administrador, ubícate en `/home/carmela` y crea un directorio `bin`:
```bash
cd /home/carmela
sudo mkdir bin
```

```bash
┌──(root㉿kali)-[~]
└─# cd /home/carmela && mkdir bin

┌──(root㉿kali)-[/home/carmela]
└─# ls -l /home/carmela
total 4
drwxrwxr-x 2 root root 4096 Feb 26 07:17 bin
```

5. En la terminal de administrador, edita el archivo `.profile` con permisos de `sudo`:
```bash
sudo nano .profile
```
Añade al final la línea:
```bash
PATH="$HOME/bin"
```

```bash
┌──(root㉿kali)-[/home/carmela]
└─# tail -n 1 .profile
PATH="$HOME/bin"
```

6. En la terminal de `carmela`, sal del shell con `exit` y vuelve a entrar con `sudo -u carmela -i`. Verifica que ya no puedes ejecutar ningún comando como `ls` o `ps`.

```bash
┌──(root㉿kali)-[/home/carmela]
└─# which ls
ls: aliased to ls --color=auto

┌──(root㉿kali)-[/home/carmela]
└─# whereis ls
ls: /usr/bin/ls /usr/share/man/man1/ls.1.gz

┌──(root㉿kali)-[/home/carmela]
└─# which ps
/usr/bin/ps
```

```bash
┌──(carmela㉿kali)-[~]
└─$ ls
-rbash: /usr/lib/command-not-found: restricted: cannot specify `/' in command names

┌──(carmela㉿kali)-[~]
└─$ ps
-rbash: /usr/lib/command-not-found: restricted: cannot specify `/' in command names
```

7. En la terminal de administrador, crea enlaces simbólicos para permitir que `carmela` use ciertos comandos:
```bash
sudo ln -s /bin/ls /home/carmela/bin/ls
sudo ln -s /bin/rm /home/carmela/bin/rm
sudo ln -s /bin/vi /home/carmela/bin/vi
sudo ln -s /bin/nano /home/carmela/bin/nano
```